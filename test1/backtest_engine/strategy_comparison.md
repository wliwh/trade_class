# ETF 策略逻辑对比文档

论坛上流行的ETF轮动策略，自2023年的wy的“核心资产轮动”，陆续出现大批。。。

现在，选了五种 ETF 轮动策略，对比了它们的逻辑差异和实际绩效，包括下面几种。

**涉及策略：**
1.  `wy03`，[原版](https://www.joinquant.com/post/42673)，2023年6月
2.  `long`，[长短期动量结合版](https://www.joinquant.com/view/community/detail/44046)，2023年9月
3.  `yj15`，[综合择时版](https://www.joinquant.com/view/community/detail/41718)，2023年4月
4.  `atr`，ATR稳健版
5.  `gao`，高收益版

---

## 策略详情

### 1. 祖版 (ETF_wy03.py)
*   **定位**：最基础的动量轮动策略，作为其他策略的修改基准。
*   **核心逻辑 (Ranking)**：
    *   基于收盘价的对数 (`np.log(close)`) 进行线性回归。
    *   评分公式：$Score = AnnualizedReturn \times R^2$
    *   选取分数最高的 1 只 ETF。
*   **交易执行**：
    *   每日 **09:30** 运行。
    *   **卖出**：若持仓不在目标列表（Top 1），清仓。
    *   **买入**：若有空位，买入目标列表中的 ETF。
*   **风控/择时**：无。纯粹的满仓轮动。

### 2. ATR稳健版 (ETF_atr_modular.py)
*   **定位**：强调稳健性和回撤控制，引入 ATR 动态止损和多种技术指标过滤。
*   **核心逻辑 (Ranking)**：
    *   与祖版类似，计算 $Score = AnnualizedReturn \times R^2$。
    *   **差异点**：线性回归采用了**线性加权** (`w = np.linspace(1, 2, len(y))`)，赋予近期数据更高权重。
*   **风控与过滤 (Filter)**：
    *   **防御模式**：若 Top 1 分数低于阈值 (`MIN_SCORE_THRESHOLD`)，则买入货币/防御 ETF (`511880`) 或空仓。
    *   **ATR 动态止损**：盘前/盘中动态计算止损价，跌破即卖。
    *   **短期动量过滤**：剔除短期（如12日）涨幅过低的标的。
    *   **技术指标过滤**：支持 MA, RSI, MACD, 布林带等可选过滤。
    *   **3日跌幅限制**：剔除近3日跌幅过大的标的。
    *   **成交量过滤**：剔除成交量异常放大的标的。
*   **交易执行**：
    *   每日 **14:20**（尾盘）执行轮动交易。
    *   每日 **09:30** 执行止损检查。

### 3. 高收益版 (ETF_gao_modular.py)
*   **定位**：追求高收益，交易时间独特，强调对成交量异常的快速反应。
*   **核心逻辑 (Ranking)**：
    *   延续 $Score = AnnualizedReturn \times R^2$ (带线性加权)。
*   **风控与过滤 (Filter)**：
    *   **Score分值过滤**：设置范围，低于或高于该范围的标的将被剔除。
    *   **成交量异常**：重点监控。若当日成交量相对历史均量异常放大（放量滞涨/下跌），视为危险信号，卖出或不买。
    *   **3日跌幅限制**：剔除近3日跌幅过大的标的。
    *   **MA均线过滤**：价格低于均线则剔除，默认未开启。
*   **交易执行**：
    *   **10:29** 执行**卖出**：检查是否放量异常、是否排名下降。
    *   **10:30** 执行**买入**：根据排名和成交量过滤买入。
    *   选在上午 10:30 交易是为了在早盘确认趋势后尽早介入，而非等到尾盘。

### 4. 长短结合版 (ETF_long_modular.py)
*   **定位**：核心资产轮动改进版，引入“反转”因子和独特的差异化风控。
*   **核心逻辑 (Ranking)**：
    *   **复合因子**：$Score = Score_{short} - \frac{Score_{long}}{6}$
    *   结合了 25日短期动量（正分）和 200日长期反转（负分，即长期涨太多的减分）。
*   **风控与过滤 (Filter)**：
    *   **极值差离过滤 (Spread Filter)**：计算第一名和最后一名的分差。若分差过大（>15，意味着市场两极分化严重）或过小（<0.1，意味着无明显主线），则**空仓**。
    *   **个股 RSRS 择时**：对每个候选 ETF 单独计算 RSRS Beta。若 Beta 低于阈值（意味着处于顶部风险区域），则剔除不买。
*   **交易执行**：
    *   每日 **09:30** 运行。

### 5. 综合择时版 (ETF_yj15_modular.py)
*   **定位**：体系最庞大的版本，引入大盘（沪深300）择时作为总开关，并重构了动量算法。
*   **核心逻辑 (Ranking)**：
    *   **算法改变**：不再使用 `log(price)` 回归。
    *   **乖离动量**：计算 `Bias = Close / MA(90)`，对 Bias 序列进行拟合求斜率。
    *   **修正因子**：
        *   持有重仓股加分 (`SwitchFactor`)：降低换手。
        *   涨跌幅因子 (`adr`)：参考前一日涨跌幅。
*   **风控与择时 (Timing & Filter)**：
    *   **大盘 RSRS 择时**：计算 **沪深300** 的 RSRS 指标，决定是 BUY (满仓) 还是 SELL (空仓)。这是**总开关**。
    *   **趋势一阶导**：监控大盘和个股的动量变化率，变化过快（急涨急跌前兆）则空仓。
    *   **WR 指标**：威廉指标辅助判断超买超卖。
    *   **盘中动态止损**：
        *   **11:25 / 11:27** 两次检查。
        *   条件：60分钟线跌破 MA20 且 价格低于昨日收盘价。
*   **交易执行**：
    *   **09:30** 卖出。
    *   **09:35** 买入。
    *   相比其他策略，它将买卖分开了 5 分钟，且有盘中 11:30 附近的止损检查。
*   **交易时间对收益的影响**：
    *   **现象**：回测表明，将交易时间推迟（如 10:30, 13:30, 14:30）会导致收益降低、回撤增大。
    *   **原因 1 - 信号滞后**：`yj15` 的核心排名是基于**前一日收盘**数据计算的。随着交易时间推迟，信号的时效性迅速衰减。市场当天的信息（开盘后的暴涨暴跌）未被纳入模型，导致用"旧地图"走"新路"。
    *   **原因 2 - 踏空日内动量**：动量策略由于优选强势股，强势股往往在早盘有较高的上涨概率（动量延续）。推迟买入（例如到 10:30）意味着错过了开盘第一小时往往最剧烈的涨幅段，被迫以更高成本建仓。
    *   **原因 3 - 止损错位**：虽然盘中风控独立运行，但延迟交易会导致对"旧持仓"的持有时间被动延长。若旧持仓当日大跌，本应在 9:30 卖出，推迟会导致多承受数小时的下跌亏损。

---

## 策略横向对比表

| 特征 | 祖版 (wy03) | ATR稳健版 (atr) | 高收益版 (gao) | 长短结合版 (long) | 综合择时版 (yj15) |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **评分核心** | 年化收益 $\times R^2$ | 年化收益 $\times R^2$ (加权) | 年化收益 $\times R^2$ (加权) | **短期动量 - 长期反转** | **乖离率(Bias) 斜率** |
| **参考价格** | 对数价格 | 对数价格 | 对数价格 | 对数价格 | **Bias (Close/MA90)** |
| **交易时间** | 09:30 | **14:20** (尾盘) | **10:30** (早盘) | 09:30 | 09:30 卖 / 09:35 买 |
| **大盘择时** | 无 | 无 | 无 | 无 | **有 (沪深300 RSRS)** |
| **个股风控** | 无 | **ATR止损**, MA, RSI... | **成交量异常**, MA | **个股RSRS**, 极值差离 | **盘中60分线止损** |
| **空仓机制** | 无 (满仓轮动) | 分数低入防御/空仓 | 分数低/异常则空仓 | 分差异常则空仓 | RSRS/动量信号触发空仓 |
| **特殊机制** | - | 防御标的(货币ETF) | 盘中成交量监控 | "枪打出头鸟"过滤 | 换仓惩罚(降低换手) |

## 总结建议

*   **追求简单粗暴**：选择 **wy03 (祖版)**。
*   **追求日内稳健与技术指标过滤**：选择 **atr (ATR版)**，功能最全，模块化程度高，适合在此基础上魔改。
*   **追求盘中及时反应与高波段**：选择 **gao (高收益版)**，10:30 交易能避开早盘假动作，也能吃到日内后续涨幅。
*   **追求因子多样性与防抱团崩塌**：选择 **long (长短结合版)**，反转因子和极值差离过滤能有效避免在极度拥挤时高位接盘。
*   **追求大盘择时与精细操作**：选择 **yj15 (综合版)**，这更像一个完整的交易系统，而非简单的轮动脚本，适合资金量稍大、需要大盘择时保护的场景。 **注意：该策略对交易时间敏感，推荐在开盘时段交易。**

---

## 回测结果比较指标

在进行超参数调优（例如测试不同交易时间）时，建议通过 `gt.get_risk()` 接口对比以下核心数据：

### 1. 核心收益与风险
*   **`algorithm_return` (策略总收益)**: 最直观的累计收益。
*   **`annual_algo_return` (策略年化收益)**: 用于对比不同时间跨度下的盈利能力。
*   **`max_drawdown` (最大回撤)**: **非常关键**。代表历史上策略最大的“深坑”。收益再高，回撤太大（如 >25%）都可能导致实盘心理崩溃。推迟交易时间往往会显著恶化此指标。

### 2. 性价比指标
*   **`sharpe` (夏普比率)**: 每一份风险带来的超额收益。越高越好（>1.5 优秀，>2.0 极佳）。如果推迟交易导致夏普下降，说明“不划算”。
*   **`sortino` (索提诺比率)**: 类似夏普，但只惩罚下行风险。对于动量策略，这个指标比夏普更有参考价值。

### 3. 先胜率与稳定性
*   **`win_ratio` (胜率)**: 虽然动量策略通常胜率不高（靠盈亏比取胜），但如果参数调整导致胜率显著下降，需要警惕。
*   **`profit_loss_ratio` (盈亏比)**: 盈利交易的平均收益 / 亏损交易的平均亏损。动量策略此值应较高。
